NATIVE_ENABLED = true
BYTE_ENABLED = false

USE_OCAMLFIND = true
OCAMLPACKS[] =
	dynlink
	unix
	str

OCAMLOPTFLAGS += -g

%.o: %.c
	$(OCAMLC) $(mapprefix -ccopt, $(CFLAGS)) -c $^

ld_util.a ld_util.cmxa: ld_header.cmx ld_util.cmx ld_stubs.o
	ocamlmklib -o ld_util $^

OCAML_LIBS[] =
    ld_util

known_mod_table.cmxs: known_mod_table.cmx
    $(OCAMLFIND) ocamlopt -o $@ -shared $^

ld_known_modules.ml: gen_known_mod_info known_mod_table.cmxs
	./gen_known_mod_info known_mod_table.cmxs > $@

ld_ocaml.opt: ld_util.cmxa ld_ocaml.cmx
    $(OCAMLFIND) ocamlopt $(OCAMLOPTFLAGS) \
	$(mapprefix -package, $(OCAMLPACKS)) \
	-cc "gcc -Wl,--whole-archive" -o $@ $+ \
	-linkpkg -linkall -ccopt -Wl,--no-whole-archive \
	-cclib -L.

OCamlProgram(ld_ocaml, ld_ocaml)
OCamlProgram(gen_known_mod_info, gen_known_mod_info)

.DEFAULT: ld_util.cmxa ld_ocaml.opt

.PHONY: clean

clean:
	rm -f $(filter-proper-targets $(ls R, .)) *.s *.annot *.so *.a
